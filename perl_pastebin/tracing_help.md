# Руководство по Трассировке и Анализу Логов

Эта система реализует подход "Poor man's tracing" (трассировка для "бедных"). Вместо сложного инструментария типа Jaeger, мы используем централизованные, структурированные логи для отслеживания запросов.

**Основная идея:** Каждый запрос, проходящий через сервис, помечается уникальным идентификатором `trace_id`. Фильтруя логи по этому `trace_id`, мы можем увидеть полную историю одного конкретного запроса.

## Начало работы

1.  **Откройте Grafana:** Перейдите по адресу `http://localhost:3100`.
2.  **Перейдите в раздел Explore:** В меню слева нажмите на иконку компаса (Explore).
3.  **Выберите источник данных Loki:** В выпадающем списке вверху слева выберите `Loki`.

## Как смотреть логи

### Шаг 1: Просмотр сырых логов

Чтобы увидеть все логи, которые приходят от нашего сервиса, введите следующий запрос и нажмите "Run query":

```logql
{service="pastebin"}
```

### Шаг 2: Структурированный вид (Парсинг JSON)

Чтобы Grafana распознала наш JSON-формат и разложила данные по колонкам, добавьте к запросу парсер `| json`:

```logql
{service="pastebin"} | json
```

Теперь вы увидите удобную таблицу с полями `level`, `message`, `trace_id`, `span_id` и т.д.

## Трассировка запроса: Основной сценарий

Это главный рабочий процесс для отладки.

1.  **Найдите зацепку.** Выполните запрос `{service="pastebin"} | json`, чтобы увидеть последние логи. Найдите любую строку, относящуюся к интересующему вас событию (например, последнюю ошибку или просто любой недавний запрос).

2.  **Получите `trace_id`.** Скопируйте значение из колонки `trace_id` у этой строки.
    *   **Простой способ:** Наведите курсор на значение `trace_id` и нажмите на появившийся значок **`+`** (лупа с плюсом). Grafana автоматически добавит фильтр в ваш запрос.

3.  **Посмотрите полную историю.** Ваш запрос теперь выглядит так:
    ```logql
    {service="pastebin"} | json | trace_id="BCCC4F44-6A81-11F0-8BD1-F407D05C6E46"
    ```
    Нажмите "Run query".

**Результат:** Вы видите отсортированный по времени список всех логов, относящихся **только к этому одному запросу**. Это полная история его жизненного цикла в сервисе.

## Практические рецепты

### Отладка ошибки

1.  **Найдите все ошибки:**
    ```logql
    {service="pastebin"} | json | level="error"
    ```
2.  **Найдите `trace_id`** у интересующей вас ошибки.
3.  **Посмотрите контекст,** выполнив поиск по этому `trace_id`, чтобы увидеть, что происходило до сбоя:
    ```logql
    {service="pastebin"} | json | trace_id="ID_ОШИБОЧНОГО_ЗАПРОСА"
    ```

### Поиск по содержимому лога

*   Найти все случаи, когда документ не был найден:
    ```logql
    {service="pastebin"} | json | message |= "Document not found"
    ```
*   Найти все действия, связанные с конкретным ID пасты:
    ```logql
    {service="pastebin"} | json | message |= "ID '021d910b7f'"
    ```

## Шпаргалка по LogQL запросам

*   `=` — точное совпадение (`level="error"`)
*   `!=` — не равно (`level!="info"`)
*   `|=` — строка содержит подстроку (`message |= "failed"`)
*   `!~` — строка не соответствует регулярному выражению (`message !~ "success.+"`)

**Пример комплексного запроса:** Найти все POST-запросы, которые не привели к ошибке.
```logql
{service="pastebin"} | json | method="POST" and level!="error"
```